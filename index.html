<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantalla de Pedidos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <span style="font-size: 32px;">üö¢</span>
                <span>Salidas</span>
            </div>
            <div class="date" id="date">00/00/0000</div>
        </div>
        
        <div class="column-headers">
            <div class="header-date">
                Fecha Entrega
                <button class="sort-btn" id="sortFechaAsc">‚Üë</button>
                <button class="sort-btn" id="sortFechaDesc">‚Üì</button>
            </div>
            <div class="header-ship">
                Barco
                <button class="sort-btn" id="sortBarcoAsc">‚Üë</button>
                <button class="sort-btn" id="sortBarcoDesc">‚Üì</button>
            </div>
            <div class="header-number">N√∫mero Pedido</div>
            <div class="header-status">
                Estado
                <button class="sort-btn" id="sortEstadoAsc">‚Üë</button>
                <button class="sort-btn" id="sortEstadoDesc">‚Üì</button>
            </div>
        </div>
        
        <div class="departure-board" id="departureBoard">
            <div class="loading">Cargando datos...</div>
        </div>
    </div>





    <script>
        // CONFIGURACI√ìN
        const useMockData = false; // Set to false to use Google Sheets
        const SHEET_NAME = 'Pedidos'; // Cambia esto si tu hoja tiene otro nombre


        const SPREADSHEET_ID = '1s4UujUFauUSvfK25IwE3dwuCs9mVNzt45ScIrooVlbA'; // Reemplaza con tu ID de Spreadsheet
        const API_KEY = 'AIzaSyDOjxTMxlPAGOEayC0JwD28mx21zd6xkk8'; // Reemplaza con tu API Key


        // Variables globales
        let allPedidos = [];
        let currentSortBy = 'fecha';
        let currentSortOrder = 'asc';


        // Funci√≥n para filtrar por barco
        function filterByBarco(barco) {
            const filteredPedidos = allPedidos.filter(p => p.barco === barco);
            renderDepartures(filteredPedidos);

            let showAllButton = document.getElementById('showAllButton');
            if (!showAllButton) {
                showAllButton = document.createElement('button');
                showAllButton.id = 'showAllButton';
                showAllButton.className = 'show-all-btn';
                document.querySelector('.header .logo').appendChild(showAllButton);
                
                showAllButton.onclick = () => {
                    renderDepartures(allPedidos);
                    showAllButton.remove();
                };
            }
            
            showAllButton.textContent = `Mostrando solo "${barco}". Click para ver todos.`;
        }



        // Funci√≥n para convertir color RGB de Google Sheets a CSS
        function rgbToHex(color) {
            if (!color) return null;
            const r = Math.round((color.red || 0) * 255);
            const g = Math.round((color.green || 0) * 255);
            const b = Math.round((color.blue || 0) * 255);
            return `rgb(${r}, ${g}, ${b})`;
        }


        // Funci√≥n para actualizar la fecha
        function updateDate() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('date').textContent = day + '/' + month + '/' + year
        }

        // Funci√≥n para cargar datos desde Google Sheets API
        async function loadData() {
            try {
                document.getElementById('departureBoard').innerHTML = '<div class="loading">Cargando datos...</div>';
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?ranges=${SHEET_NAME}&includeGridData=true&key=${API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Error al conectar con Google Sheets. Verifica tu API Key y permisos.');
                }
                
                const data = await response.json();
                const pedidos = parseGoogleSheets(data);
                
                if (pedidos.length === 0) {
                    throw new Error('No se encontraron datos en la hoja');
                }
                
                allPedidos = pedidos;
                renderDepartures(allPedidos);
            } catch (error) {
                console.error('Error al cargar datos:', error);
                document.getElementById('departureBoard').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Error al cargar los datos</h3>
                        <p>${error.message}</p>
                        <p>Verifica la configuraci√≥n en el c√≥digo JavaScript.</p>
                    </div>
                `;
            }
        }

        // Funci√≥n para parsear datos de Google Sheets API
        function parseGoogleSheets(data) {
            const rows = data.sheets[0].data[0].rowData;
            if (!rows || rows.length < 2) return [];

            // Obtener encabezados de la primera fila
            const headers = rows[0].values.map(cell => 
                (cell.formattedValue || '').trim().toLowerCase()
            );

            // Buscar √≠ndices de columnas
            const getColumnIndex = (possibleNames) => {
                for (let name of possibleNames) {
                    const index = headers.findIndex(h => h.includes(name.toLowerCase()));
                    if (index !== -1) return index;
                }
                return -1;
            };

            const barcoIndex = getColumnIndex(['barco']);
            const lugarIndex = getColumnIndex(['lugar de entrega', 'lugar', 'entrega']);
            const numeroIndex = getColumnIndex(['n√∫mero de pedido', 'numero', 'pedido']);
            const fechaIndex = getColumnIndex(['fecha de entrega', 'fecha']);
            const estadoIndex = getColumnIndex(['estado']);

            const pedidos = [];

            // Procesar filas (empezando desde la fila 2, √≠ndice 1)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row.values || !row.values[barcoIndex]?.formattedValue) continue;

                const barcoCell = row.values[barcoIndex];
                const colorFondo = barcoCell.effectiveFormat?.backgroundColor;
                const colorTexto = barcoCell.effectiveFormat?.textFormat?.foregroundColor;

                pedidos.push({
                    barco: row.values[barcoIndex]?.formattedValue || '',
                    lugar: row.values[lugarIndex]?.formattedValue || '',
                    numero: row.values[numeroIndex]?.formattedValue || '',
                    fecha: row.values[fechaIndex]?.formattedValue || '',
                    estado: row.values[estadoIndex]?.formattedValue || 'Pendiente',
                    colorFondo: rgbToHex(colorFondo),
                    colorBarco: rgbToHex(colorTexto)
                });
            }

            return pedidos;
        }

        // Funci√≥n para ordenar pedidos
        function sortPedidos(pedidos, sortBy, order) {
            const sorted = [...pedidos].sort((a, b) => {
                let valA, valB;

                if (sortBy === 'fecha') {
                    const parseDate = (dateStr) => {
                        if (!dateStr) return new Date(0);
                        const parts = dateStr.split('/');
                        if (parts.length !== 3) return new Date(0);
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    };
                    valA = parseDate(a.fecha);
                    valB = parseDate(b.fecha);
                } else {
                    valA = a[sortBy];
                    valB = b[sortBy];
                }

                if (valA < valB) {
                    return order === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return order === 'asc' ? 1 : -1;
                }
                return 0;
            });

            return sorted;
        }



        // Funci√≥n para renderizar los pedidos
        function renderDepartures(pedidos) {
            const board = document.getElementById('departureBoard');
            board.innerHTML = '';

            if (pedidos.length === 0) {
                board.innerHTML = '<div class="loading">No hay pedidos para mostrar</div>';
                return;
            }

            const sortedPedidos = sortPedidos(pedidos, currentSortBy, currentSortOrder);

            sortedPedidos.forEach((pedido) => {
                                let statusClass = '';
                if (pedido.estado.toLowerCase().includes('parcial')) {
                    statusClass = 'status-pendiente-parcial';
                } else if (pedido.estado.toLowerCase().includes('pendiente')) {
                    statusClass = 'status-pendiente';
                }
                
                const item = document.createElement('div');
                item.className = 'departure-item';
                
                // Aplicar color de fondo si existe
                if (pedido.colorFondo) {
                    item.style.backgroundColor = pedido.colorFondo;
                }
                
                // Crear estilo inline para el color del barco
                const barcoStyle = pedido.colorBarco ? `style="color: ${pedido.colorBarco};"` : '';
                
                item.innerHTML = `
                    <div class="departure-header">
                        <div class="time">${pedido.fecha}</div>
                        <div class="destination" ${barcoStyle} onclick="filterByBarco('${pedido.barco.replace(/'/g, "'")}')">${pedido.barco}</div>
                        <div class="train-number">${pedido.numero}</div>
                        <div class="status ${statusClass}">${pedido.estado}</div>
                    </div>
                    <div class="stops-container">
                        <div class="stops">
                            <span class="stops-content">${pedido.lugar}</span>
                        </div>
                    </div>
                `;
                
                board.appendChild(item);
                
                // Detectar si el texto necesita scroll
                setTimeout(() => {
                    const stopsContent = item.querySelector('.stops-content');
                    const stopsContainer = item.querySelector('.stops-container');
                    if (stopsContent && stopsContainer) {
                        const contentWidth = stopsContent.scrollWidth;
                        const containerWidth = stopsContainer.offsetWidth;
                        
                        if (contentWidth > containerWidth) {
                            stopsContent.classList.add('scroll-animation');
                        }
                    }
                }, 200);
            });
        }

        // Inicializar
        updateDate();
        loadData();

        document.getElementById('sortFechaAsc').addEventListener('click', () => {
            currentSortBy = 'fecha';
            currentSortOrder = 'asc';
            renderDepartures(allPedidos);
        });
        document.getElementById('sortFechaDesc').addEventListener('click', () => {
            currentSortBy = 'fecha';
            currentSortOrder = 'desc';
            renderDepartures(allPedidos);
        });
        document.getElementById('sortBarcoAsc').addEventListener('click', () => {
            currentSortBy = 'barco';
            currentSortOrder = 'asc';
            renderDepartures(allPedidos);
        });
        document.getElementById('sortBarcoDesc').addEventListener('click', () => {
            currentSortBy = 'barco';
            currentSortOrder = 'desc';
            renderDepartures(allPedidos);
        });
        document.getElementById('sortEstadoAsc').addEventListener('click', () => {
            currentSortBy = 'estado';
            currentSortOrder = 'asc';
            renderDepartures(allPedidos);
        });
        document.getElementById('sortEstadoDesc').addEventListener('click', () => {
            currentSortBy = 'estado';
            currentSortOrder = 'desc';
            renderDepartures(allPedidos);
        });

        // Recargar datos cada 30 minutos
        setInterval(loadData, 1800000);


    </script>
    <svg id="noise-filter">
        <filter id="glass-distortion">
            <feTurbulence type="fractalNoise" baseFrequency="0.008" numOctaves="1" result="warp" />
            <feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="77" in="SourceGraphic" in2="warp" />
        </filter>
    </svg>
</body>
</html>